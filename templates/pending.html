{% extends "base.html" %}

{% block title %}Pending Requests - Supervisor Portal{% endblock %}

{% block content %}
<div class="card">
    <h2>üìã Pending Help Requests</h2>
    <p style="color: #7f8c8d; margin-bottom: 1.5rem;">
        These are questions the AI couldn't answer. Submit your response to notify the caller and update the knowledge base.
    </p>
    
    {% if requests %}
        {% for req in requests %}
        <div class="card" style="border-left: 4px solid #f39c12; background: #fef9e7;">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                <div>
                    <span class="badge badge-pending">PENDING</span>
                    <span style="color: #7f8c8d; font-size: 0.9rem; margin-left: 1rem;">
                        {{ req.created_at.strftime('%Y-%m-%d %H:%M') if req.created_at else 'Just now' }}
                    </span>
                </div>
                <div style="text-align: right; color: #7f8c8d; font-size: 0.9rem;">
                    <div><strong>Caller:</strong> {{ req.caller_name }}</div>
                    <div><strong>Phone:</strong> {{ req.caller_phone }}</div>
                </div>
            </div>
            
            <div style="background: white; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #2c3e50;">‚ùì Question:</div>
                <div style="font-size: 1.1rem;">{{ req.question }}</div>
            </div>
            
            {% if req.context %}
            <div style="background: white; padding: 1rem; border-radius: 4px; margin-bottom: 1rem;">
                <div style="font-weight: 600; margin-bottom: 0.5rem; color: #7f8c8d;">üìù Context:</div>
                <div style="font-size: 0.95rem;">{{ req.context }}</div>
            </div>
            {% endif %}
            
            <form onsubmit="submitAnswer(event, '{{ req.id }}')">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Your Answer:</label>
                    <textarea id="answer-{{ req.id }}" required placeholder="Type your answer here..."></textarea>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Your Name:</label>
                    <input type="text" id="supervisor-{{ req.id }}" value="Supervisor" required>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">‚úÖ Submit Answer & Notify Caller</button>
                    <button type="button" onclick="rejectRequest(event, '{{ req.id }}')" class="btn" style="flex: 0.4; background: #e74c3c; color: white;">‚ùå Reject</button>
                </div>
            </form>
        </div>
        {% endfor %}
    {% else %}
        <div style="text-align: center; padding: 3rem; color: #7f8c8d;">
            <div style="font-size: 3rem; margin-bottom: 1rem;">‚ú®</div>
            <h3>No Pending Requests</h3>
            <p>All questions have been answered! The AI is doing great.</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
async function submitAnswer(event, requestId) {
    event.preventDefault();
    
    const answer = document.getElementById(`answer-${requestId}`).value;
    const supervisorName = document.getElementById(`supervisor-${requestId}`).value;
    
    try {
        const response = await fetch('/api/submit-answer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                request_id: requestId,
                answer: answer,
                supervisor_name: supervisorName
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('‚úÖ Answer submitted! Caller notified and knowledge base updated.', 'success');
            setTimeout(() => location.reload(), 2000);
        } else {
            showAlert('‚ùå Error: ' + data.error, 'error');
        }
    } catch (error) {
        showAlert('‚ùå Network error: ' + error.message, 'error');
    }
}

async function rejectRequest(event, requestId) {
    event.preventDefault();
    
    const reason = prompt('Reason for rejection (optional):');
    
    if (reason === null) {
        // User cancelled
        return;
    }
    
    if (!confirm('Are you sure you want to reject this request? The caller will not be notified.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/reject-request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                request_id: requestId,
                reason: reason || 'No reason provided'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('‚úÖ Request rejected successfully.', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showAlert('‚ùå Error: ' + data.error, 'error');
        }
    } catch (error) {
        showAlert('‚ùå Network error: ' + error.message, 'error');
    }
}
</script>
{% endblock %}
